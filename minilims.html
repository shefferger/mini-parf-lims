<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Parf LIMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background:#111; color:#ddd; margin:0; padding:0; }
    .card { background:#1c1c1c; }
    .table input { background:#222; color:#eee; border:1px solid #444; width:100%; }
    .table input:focus { background:#2a2a2a; color:#eee !important; border-color:#666; outline:none; }
    .table .form-control-sm { padding: 0.15rem 0.3rem; font-size: 0.8rem; }
    .note-header { letter-spacing:1px; text-transform:uppercase; font-size:0.85rem; }
    .table { table-layout: fixed; width:100%; }
    .table td, .table th { vertical-align: middle; padding:0.5rem; }
    .table td { overflow:hidden; }

    /* –®–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
    .col-4 { width: 4% !important; }
    .col-5 { width: 5% !important; }
    .col-8 { width: 8% !important; }
    .col-10 { width: 10% !important; }
    .col-25 { width: 25% !important; }
    .btn-delete { width:24px; height:24px; padding:0; line-height:1; font-size:18px; font-weight:bold; }
    .btn-narrow { min-width: auto; padding: 0.2rem 0.3rem; font-size: 0.75rem; max-width: 100px; }
    
    .header-section { position:fixed; top:0; left:0; right:0; background:#111; z-index:1000; padding:1rem; border-bottom:1px solid #333; }
    .scrollable-content { margin-top:250px; padding:1rem; }

    #title, #totalVolume {
      background: #2a2a2a !important;
      color: #fff !important;
      border: 1px solid #444;
    }
    #title:focus, #totalVolume:focus {
      background: #333 !important;
      color: #fff !important;
      border-color: #666;
      outline: none;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ä—è–¥–æ–≤ —Ç–∞–±–ª–∏—Ü—ã */
    @keyframes fadeInRow {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes fadeOutRow {
      from {
        opacity: 1;
        transform: scale(1);
        max-height: 60px;
      }
      to {
        opacity: 0;
        transform: scale(0.95);
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
    }

    .row-fade-in {
      animation: fadeInRow 0.4s ease-out;
    }

    .row-fade-out {
      animation: fadeOutRow 0.3s ease-in forwards;
      overflow: hidden;
    }

    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    @keyframes slideInCard {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-fade-in {
      animation: slideInCard 0.5s ease-out;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .btn-add-click {
      animation: buttonClick 0.2s ease-out;
    }

    @keyframes buttonClick {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); }
      100% { transform: scale(1); }
    }

    /* Sticky –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
    .sticky-table-header {
      position: fixed;
      left: 0;
      right: 0;
      z-index: 100;
      background: #111;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      padding: 1rem;
    }

    .sticky-table-header table {
      margin-bottom: 0;
      table-layout: fixed;
      width: 100%;
    }

    .sticky-table-header thead th {
      border-bottom: 2px solid #444;
      background: #1c1c1c;
      font-weight: 600;
    }

    /* –°–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
    .note-section-header {
      background: #2a2a2a;
      color: #ddd;
      padding: 0.5rem 1rem;
      margin: 0;
      border-bottom: 1px solid #444;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .section-table {
      margin-bottom: 0.5rem;
    }

    .section-table tbody tr:first-child td {
      border-top: 2px solid #444;
    }

    /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏ */
    .card + .card {
      border-top: 1px solid #333;
      padding-top: 0.5rem;
    }
    
    .ifra-warning-input {
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.3);
      animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.3); }
      50% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), 0 0 30px rgba(255, 0, 0, 0.5); }
    }
    .eff-conc-label {
      font-size: 0.8rem;
      color: #aaa;
      white-space: nowrap;
    }
    .tooltip-wrapper {
      position: relative;
      display: inline;
    }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden;
      background-color: #ff0000;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 5px 8px;
      position: absolute;
      z-index: 1001;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip-wrapper:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>

<div class="header-section">
  <div class="container">
    <h3 class="mb-3">üß¥ Mini Parf LIMS</h3>
    
    <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ–ª—è–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
    <div class="card p-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label text-light">Formula title</label>
          <input id="title" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label text-light">Total volume (ml)</label>
          <input id="totalVolume" type="number" step="0.01" class="form-control" oninput="totalVolumeChanged()">
        </div>
        <div class="col-md-3">
          <label class="form-label text-light">Statistics</label>
          <div class="text-light">
            <div><strong>Total ml:</strong> <span id="stat-ml">0</span></div>
            <div><strong>Total concentration:</strong> <span id="stat-percent">0</span>%</div>
          </div>
          <div id="volume-warning" class="alert alert-warning alert-dismissible fade show mt-2 mb-0" role="alert" style="display:none; padding:0.5rem; font-size:0.85rem;">
            <strong>Warning:</strong> Total ml ‚â† Total volume. Please check your input.
            <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('volume-warning').style.display='none'" aria-label="Close"></button>
          </div>
        </div>
        <div class="col-md-3 d-flex flex-column gap-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="autoUpdate" checked onchange="autoUpdateChanged()">
            <label class="form-check-label text-light" for="autoUpdate" style="font-size:0.9rem;">
              Auto-update fields
            </label>
          </div>
          <div class="d-flex align-items-end gap-2">
            <button class="btn btn-danger flex-fill" onclick="exportPDF()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF">üìÑ PDF</button>
            <button class="btn btn-success flex-fill" onclick="saveJSON()">Save</button>
            <label class="btn btn-secondary flex-fill mb-0">
              Load <input type="file" hidden onchange="loadJSON(event)">
            </label>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Sticky –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
  <div class="sticky-table-header">
    <div class="container">
      <table class="table table-dark table-sm align-middle">
        <thead>
          <tr>
            <th class="col-4">#</th>
            <th class="col-25">Name</th>
            <th class="col-10">Conc %</th>
            <th class="col-8">Eff. conc %</th>
            <th class="col-10">IFRA Max %</th>
            <th class="col-10">Amount %</th>
            <th class="col-10">Amount ml</th>
            <th class="col-5"></th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>

<div class="scrollable-content">
  <div class="container">
    <!-- TABLES -->
    <div id="tables"></div>
  </div>
</div>

<script>
const NOTES = [
  { key: 'base', label: 'Base notes' },
  { key: 'middle', label: 'Middle notes' },
  { key: 'top', label: 'Top notes' }
];

let rows = [];
let focusState = null; // {id, field, cursorPos}

function createRow(note) {
  // ID –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –≤ render() –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
  // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  const tempId = Date.now() + Math.random();
  
  return {
    id: tempId,
    note,
    name: '',
    concentration: '',
    amount_percent: '',
    amount_ml: '',
    ifra_max: ''
  };
}

function render() {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ, –Ω–µ –¥–ª—è totalVolume)
  const activeElement = document.activeElement;
  if (activeElement && activeElement.tagName === 'INPUT' && activeElement.id !== 'totalVolume') {
    const inputId = activeElement.getAttribute('data-row-id');
    const inputField = activeElement.getAttribute('data-field');
    if (inputId && inputField) {
      const currentValue = activeElement.value;
      const cursorPos = activeElement.selectionStart || 0;
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ID –≤ —á–∏—Å–ª–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
      const numericId = parseFloat(inputId) || inputId;
      focusState = {
        id: numericId,
        field: inputField,
        cursorPos: cursorPos,
        previousValue: currentValue // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
      };
    } else {
      // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–µ –Ω–∞ –ø–æ–ª–µ —Ç–∞–±–ª–∏—Ü—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      focusState = null;
    }
  } else {
    // –ï—Å–ª–∏ —Ñ–æ–∫—É—Å –Ω–∞ totalVolume –∏–ª–∏ –¥—Ä—É–≥–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    focusState = null;
  }

  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
  let globalRowNumber = 1;
  const idMapping = new Map(); // –°—Ç–∞—Ä—ã–π ID -> –ù–æ–≤—ã–π ID
  
  NOTES.forEach(n => {
    const noteRows = rows.filter(r => r.note === n.key);
    noteRows.forEach(r => {
      const oldId = r.id;
      r.id = globalRowNumber++;
      idMapping.set(oldId, r.id);
    });
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º focusState —Å –Ω–æ–≤—ã–º ID, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω
  if (focusState) {
    const newId = idMapping.get(focusState.id);
    if (newId !== undefined) {
      focusState.id = newId;
    } else {
      // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞–ø–ø–∏–Ω–≥–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º focusState
      focusState = null;
    }
  }

  const container = document.getElementById('tables');
  container.innerHTML = '';

  NOTES.forEach(n => {
    const noteRows = rows.filter(r => r.note === n.key);

    const card = document.createElement('div');
    card.className = 'card py-3 mb-2 text-light';

    card.innerHTML = `
      <div class="note-section-header">${n.label}</div>
      <table class="table table-dark table-sm align-middle section-table">
        <tbody>
          ${noteRows.map(r => {
            const effConc = calculateEffConc(r);
            const ifraMax = parseFloat(r.ifra_max) || 0;
            const hasIfraWarning = ifraMax > 0 && effConc > ifraMax;
            const inputClass = hasIfraWarning ? 'form-control form-control-sm ifra-warning-input' : 'form-control form-control-sm';
            const tooltipHtml = hasIfraWarning ? `<div class="tooltip-wrapper"><span class="tooltip-text">IFRA limit exceeded!</span></div>` : '';

            return `
            <tr>
              <td class="col-4">${r.id}</td>
              <td class="col-25"><input class="form-control form-control-sm" data-row-id="${r.id}" data-field="name" value="${r.name}" oninput="update(${r.id},'name',this.value)"></td>
              <td class="col-10"><input class="form-control form-control-sm" type="number" step="0.01" data-row-id="${r.id}" data-field="concentration" value="${r.concentration}" oninput="concentrationChanged(${r.id},this.value)"></td>
              <td class="col-8 text-center">${effConc.toFixed(2)}</td>
              <td class="col-10">${tooltipHtml}<input class="${inputClass}" type="number" step="0.01" data-row-id="${r.id}" data-field="ifra_max" value="${r.ifra_max}" oninput="update(${r.id},'ifra_max',this.value); updateEffConcDisplay(${r.id})"></td>
              <td class="col-10"><input class="form-control form-control-sm" type="number" step="0.01" data-row-id="${r.id}" data-field="amount_percent" value="${r.amount_percent}" oninput="percentChanged(${r.id},this.value)"></td>
              <td class="col-10"><input class="form-control form-control-sm" type="number" step="0.01" data-row-id="${r.id}" data-field="amount_ml" value="${r.amount_ml}" oninput="mlChanged(${r.id},this.value)"></td>
              <td class="col-5 text-center"><button class="btn btn-sm btn-outline-danger btn-delete" onclick="this.classList.add('btn-add-click'); setTimeout(() => this.classList.remove('btn-add-click'), 200); deleteRow(${r.id})" title="–£–¥–∞–ª–∏—Ç—å —Ä—è–¥">√ó</button></td>
            </tr>
          `;
          }).join('')}
        </tbody>
      </table>
      <button class="btn btn-sm btn-outline-light btn-narrow" onclick="this.classList.add('btn-add-click'); setTimeout(() => this.classList.remove('btn-add-click'), 200); addRow('${n.key}')">+ Add new row</button>
    `;
    container.appendChild(card);
  });

  recalcStats();

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º IFRA warning –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  rows.forEach(r => {
    const effConc = calculateEffConc(r);
    const ifraMax = parseFloat(r.ifra_max) || 0;
    const hasIfraWarning = ifraMax > 0 && effConc > ifraMax;

    const ifraInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="ifra_max"]`);
    const ifraCell = ifraInput?.parentElement;

    if (ifraInput && ifraCell) {
      if (hasIfraWarning) {
        ifraInput.classList.add('ifra-warning-input');
        // –î–æ–±–∞–≤–ª—è–µ–º tooltip –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!ifraCell.querySelector('.tooltip-wrapper')) {
          const tooltipWrapper = document.createElement('div');
          tooltipWrapper.className = 'tooltip-wrapper';
          tooltipWrapper.innerHTML = '<span class="tooltip-text">IFRA limit exceeded!</span>';
          ifraCell.insertBefore(tooltipWrapper, ifraCell.firstChild);
        }
      } else {
        ifraInput.classList.remove('ifra-warning-input');
        // –£–¥–∞–ª—è–µ–º tooltip –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const tooltipWrapper = ifraCell.querySelector('.tooltip-wrapper');
        if (tooltipWrapper) {
          tooltipWrapper.remove();
        }
      }
    }
  });

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
  if (focusState) {
    setTimeout(() => {
      const input = document.querySelector(`input[data-row-id="${focusState.id}"][data-field="${focusState.field}"]`);
      if (input) {
        const newValue = input.value;
        const oldValue = focusState.previousValue || '';
        
        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
        let newCursorPos = focusState.cursorPos;
        if (oldValue !== newValue) {
          // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –ø—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
          const valueDiff = newValue.length - oldValue.length;
          if (valueDiff !== 0) {
            // –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é
            newCursorPos = Math.max(0, Math.min(focusState.cursorPos + valueDiff, newValue.length));
          } else {
            // –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
            newCursorPos = Math.min(focusState.cursorPos, newValue.length);
          }
        } else {
          // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
          newCursorPos = Math.min(focusState.cursorPos, newValue.length);
        }
        
        input.focus();
        if (input.setSelectionRange) {
          input.setSelectionRange(newCursorPos, newCursorPos);
        }
      }
      focusState = null;
    }, 0);
  }
}

function autoUpdateChanged() {
  const autoUpdate = document.getElementById('autoUpdate').checked;
  
  // –ï—Å–ª–∏ –≤–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Å–µ—Ö –ø–æ–ª–µ–π
  if (autoUpdate) {
    const tv = parseFloat(totalVolume.value);
    
    if (tv) {
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º ml –∏–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, –≥–¥–µ –∑–∞–¥–∞–Ω –ø—Ä–æ—Ü–µ–Ω—Ç
      rows.forEach(r => {
        if (r.amount_percent && r.amount_percent !== '') {
          r.amount_ml = ((tv * parseFloat(r.amount_percent)) / 100).toFixed(3);
          const mlInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_ml"]`);
          if (mlInput) {
            mlInput.value = r.amount_ml;
          }
        }
      });
    }
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
    recalcAllAmountPercent();
    recalcStats();
  }
}

function totalVolumeChanged() {
  const tv = parseFloat(totalVolume.value);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  const autoUpdate = document.getElementById('autoUpdate').checked;
  if (!autoUpdate) {
    recalcStats();
    return;
  }

  if (!tv) {
    // –ï—Å–ª–∏ total volume –Ω–µ –∑–∞–¥–∞–Ω, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏–∑ —Å—É–º–º—ã –≤—Å–µ—Ö ml
    recalcAllAmountPercent();
    // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    rows.forEach(row => updateEffConcDisplay(row.id));
    recalcStats();
    return;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º ml –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º
  rows.forEach(r => {
    if (r.amount_percent && r.amount_percent !== '') {
      r.amount_ml = ((tv * parseFloat(r.amount_percent)) / 100).toFixed(3);
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤ DOM –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
      const mlInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_ml"]`);
      if (mlInput) {
        mlInput.value = r.amount_ml;
      }
    }
  });

  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º amount_percent –∏–∑ amount_ml –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  recalcAllAmountPercent();
  // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, —Ç–∞–∫ –∫–∞–∫ totalVolume –∏–∑–º–µ–Ω–∏–ª—Å—è
  rows.forEach(row => updateEffConcDisplay(row.id));

  recalcStats();
  // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º render(), —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Ñ–æ–∫—É—Å —Å totalVolume
}

function addRow(note) {
  const newRow = createRow(note);
  rows.push(newRow);
  render();

  // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∞
  setTimeout(() => {
    const newRowElement = document.querySelector(`tr:has(input[data-row-id="${newRow.id}"])`);
    if (newRowElement) {
      newRowElement.classList.add('row-fade-in');
    }
  }, 10);
}

function deleteRow(id) {
  const index = rows.findIndex(x => x.id == id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  if (index === -1) return;

  // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Ä—è–¥–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
  const rowElement = document.querySelector(`tr:has(input[data-row-id="${id}"])`);
  if (rowElement) {
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
    rowElement.classList.add('row-fade-out');

    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
    setTimeout(() => {
      rows.splice(index, 1);
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ä—è–¥–∞
      recalcAllAmountPercent();
      recalcStats();
      render();
    }, 300); // 300ms - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ fadeOutRow
  } else {
    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —É–¥–∞–ª—è–µ–º —Å—Ä–∞–∑—É
    rows.splice(index, 1);
    recalcAllAmountPercent();
    recalcStats();
    render();
  }
}

function update(id, field, value) {
  const r = rows.find(x => x.id == id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ ID –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ —á–∏—Å–ª–æ–º
  if (r) {
    r[field] = value;
    recalcStats();
  }
}

function concentrationChanged(id, value) {
  const r = rows.find(x => x.id == id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  if (r) {
    r.concentration = value;
    // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% label –∏ IFRA warning –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ render()
    updateEffConcDisplay(id);
    recalcStats();
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è eff. conc% –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä—è–¥–∞
function updateEffConcDisplay(id) {
  const r = rows.find(x => x.id == id);
  if (!r) return;

  const effConc = calculateEffConc(r);

  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ eff. conc% –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —è—á–µ–π–∫–µ (4-—è –∫–æ–ª–æ–Ω–∫–∞, –∏–Ω–¥–µ–∫—Å 3)
  const effConcCell = document.querySelector(`input[data-row-id="${id}"][data-field="concentration"]`)?.closest('tr')?.children[3];
  if (effConcCell) {
    effConcCell.textContent = effConc.toFixed(2);
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º IFRA warning –¥–ª—è input –ø–æ–ª—è
  const ifraMax = parseFloat(r.ifra_max) || 0;
  const hasIfraWarning = ifraMax > 0 && effConc > ifraMax;

  const ifraInput = document.querySelector(`input[data-row-id="${id}"][data-field="ifra_max"]`);
  const ifraCell = ifraInput?.parentElement;

  if (ifraInput && ifraCell) {
    if (hasIfraWarning) {
      ifraInput.classList.add('ifra-warning-input');
      // –î–æ–±–∞–≤–ª—è–µ–º tooltip –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if (!ifraCell.querySelector('.tooltip-wrapper')) {
        const tooltipWrapper = document.createElement('div');
        tooltipWrapper.className = 'tooltip-wrapper';
        tooltipWrapper.innerHTML = '<span class="tooltip-text">IFRA limit exceeded!</span>';
        ifraCell.insertBefore(tooltipWrapper, ifraCell.firstChild);
      }
    } else {
      ifraInput.classList.remove('ifra-warning-input');
      // –£–¥–∞–ª—è–µ–º tooltip –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const tooltipWrapper = ifraCell.querySelector('.tooltip-wrapper');
      if (tooltipWrapper) {
        tooltipWrapper.remove();
      }
    }
  }
}

function percentChanged(id, value) {
  const r = rows.find(x => x.id == id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  if (!r) return;
  
  r.amount_percent = value;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  const autoUpdate = document.getElementById('autoUpdate').checked;
  if (!autoUpdate) {
    recalcStats();
    return;
  }
  
  const tv = parseFloat(totalVolume.value);
  
  if (value === '') {
    // –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—á–∏—â–µ–Ω, –æ—á–∏—â–∞–µ–º ml
    r.amount_ml = '';
    const mlInput = document.querySelector(`input[data-row-id="${id}"][data-field="amount_ml"]`);
    if (mlInput) {
      mlInput.value = '';
    }
    // –ï—Å–ª–∏ totalVolume –ø—É—Å—Ç, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —Å—É–º–º–∞ ml –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if (!tv) {
      recalcAllAmountPercent();
      // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
      rows.forEach(row => updateEffConcDisplay(row.id));
    } else {
      // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä—è–¥–∞
      updateEffConcDisplay(id);
    }
    recalcStats();
    return;
  }
  
  if (tv) {
    // –ï—Å–ª–∏ total volume –∑–∞–¥–∞–Ω, –≤—ã—á–∏—Å–ª—è–µ–º ml –∏–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∏ total volume
    r.amount_ml = ((tv * parseFloat(value)) / 100).toFixed(3);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ ml
    const mlInput = document.querySelector(`input[data-row-id="${id}"][data-field="amount_ml"]`);
    if (mlInput) {
      mlInput.value = r.amount_ml;
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä—è–¥–∞
    updateEffConcDisplay(id);
  } else {
    // –ï—Å–ª–∏ total volume –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –≤—Å–µ—Ö ml –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ ml –∏–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–∞
    // –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—É–º–º—É
    recalcStats();
    const totalML = rows.reduce((sum, row) => {
      return sum + (parseFloat(row.amount_ml) || 0);
    }, 0);
    
    if (totalML > 0) {
      // –í—ã—á–∏—Å–ª—è–µ–º ml –∏–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Ç —Å—É–º–º—ã –≤—Å–µ—Ö ml
      r.amount_ml = ((totalML * parseFloat(value)) / 100).toFixed(3);
      const mlInput = document.querySelector(`input[data-row-id="${id}"][data-field="amount_ml"]`);
      if (mlInput) {
        mlInput.value = r.amount_ml;
      }
      // –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ml –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —Å—É–º–º–∞ ml –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
      recalcAllAmountPercent();
      // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
      rows.forEach(row => updateEffConcDisplay(row.id));
    }
  }
  
  recalcStats();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –≤ —Ä–∞—Å—Ç–≤–æ—Ä–µ
function calculateEffConc(row) {
  const conc = parseFloat(row.concentration) || 0;
  const ml = parseFloat(row.amount_ml) || 0;
  const tv = parseFloat(totalVolume.value);
  
  if (conc === 0 || ml === 0) {
    return 0;
  }
  
  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è = (concentration * amount_ml) / totalVolume * 100
  // –ï—Å–ª–∏ totalVolume –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –≤—Å–µ—Ö ml
  let totalVol = tv;
  if (!totalVol || totalVol === 0) {
    totalVol = rows.reduce((sum, r) => {
      return sum + (parseFloat(r.amount_ml) || 0);
    }, 0);
  }
  
  if (totalVol === 0) {
    return 0;
  }
  
  // –ß–∏—Å—Ç–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ –≤ –º–ª = amount_ml * (concentration / 100)
  const pureML = ml * (conc / 100);
  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è = (—á–∏—Å—Ç–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ / –æ–±—â–∏–π –æ–±—ä–µ–º) * 100
  return (pureML / totalVol) * 100;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö amount_percent
function recalcAllAmountPercent() {
  const autoUpdate = document.getElementById('autoUpdate').checked;
  if (!autoUpdate) return;
  
  const tv = parseFloat(totalVolume.value);
  
  if (tv) {
    // –ï—Å–ª–∏ total volume –∑–∞–¥–∞–Ω, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    rows.forEach(r => {
      const ml = parseFloat(r.amount_ml) || 0;
      if (ml > 0) {
        r.amount_percent = ((ml / tv) * 100).toFixed(3);
        const percentInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_percent"]`);
        if (percentInput) {
          percentInput.value = r.amount_percent;
        }
      } else if (ml === 0 && r.amount_ml === '') {
        // –ï—Å–ª–∏ ml –ø—É—Å—Ç, –æ—á–∏—â–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
        r.amount_percent = '';
        const percentInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_percent"]`);
        if (percentInput) {
          percentInput.value = '';
        }
      }
    });
  } else {
    // –ï—Å–ª–∏ total volume –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –≤—Å–µ—Ö ml
    const totalML = rows.reduce((sum, row) => {
      return sum + (parseFloat(row.amount_ml) || 0);
    }, 0);
    
    if (totalML > 0) {
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è –í–°–ï–• —Å—Ç—Ä–æ–∫
      rows.forEach(r => {
        const ml = parseFloat(r.amount_ml) || 0;
        if (ml > 0) {
          r.amount_percent = ((ml / totalML) * 100).toFixed(3);
          const percentInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_percent"]`);
          if (percentInput) {
            percentInput.value = r.amount_percent;
          }
        } else if (ml === 0 && r.amount_ml === '') {
          // –ï—Å–ª–∏ ml –ø—É—Å—Ç, –æ—á–∏—â–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
          r.amount_percent = '';
          const percentInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_percent"]`);
          if (percentInput) {
            percentInput.value = '';
          }
        }
      });
    } else {
      // –ï—Å–ª–∏ —Å—É–º–º–∞ ml —Ä–∞–≤–Ω–∞ 0, –æ—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
      rows.forEach(r => {
        r.amount_percent = '';
        const percentInput = document.querySelector(`input[data-row-id="${r.id}"][data-field="amount_percent"]`);
        if (percentInput) {
          percentInput.value = '';
        }
      });
    }
  }
}

function mlChanged(id, value) {
  const r = rows.find(x => x.id == id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º == –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  if (!r) return;
  
  r.amount_ml = value;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  const autoUpdate = document.getElementById('autoUpdate').checked;
  if (!autoUpdate) {
    // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–∞–∂–µ –µ—Å–ª–∏ autoUpdate –≤—ã–∫–ª—é—á–µ–Ω
    updateEffConcDisplay(id);
    recalcStats();
    return;
  }

  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º amount_percent –¥–ª—è –í–°–ï–• —Å—Ç—Ä–æ–∫, —Ç–∞–∫ –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ ml –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  recalcAllAmountPercent();
  // –û–±–Ω–æ–≤–ª—è–µ–º eff. conc% –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, —Ç–∞–∫ –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ml –≤–ª–∏—è–µ—Ç –Ω–∞ eff. conc% –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
  rows.forEach(row => updateEffConcDisplay(row.id));
  recalcStats();
}


function recalcStats() {
  let totalML = 0;
  let totalPureML = 0;

  rows.forEach(r => {
    const ml = parseFloat(r.amount_ml) || 0;
    const conc = parseFloat(r.concentration) || 0;

    totalML += ml;
    totalPureML += ml * (conc / 100);
  });

  // –ù–ï –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º total volume - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∑–∞–¥–∞—Ç—å –µ–≥–æ —è–≤–Ω–æ
  // total volume - —ç—Ç–æ —Ü–µ–ª–µ–≤–æ–π –æ–±—ä–µ–º –≤—Å–µ–≥–æ —Ä–∞—Å—Ç–≤–æ—Ä–∞, –∞ –Ω–µ —Å—É–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  
  const tv = parseFloat(totalVolume.value);
  
  // –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º total volume, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω
  // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—É–º–º—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–Ω–æ —ç—Ç–æ –Ω–µ —Å–æ–≤—Å–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
  let totalConcentration = 0;
  if (tv && tv > 0) {
    // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç: –æ–±—â–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è = —Å—É–º–º–∞ —á–∏—Å—Ç–æ–≥–æ –≤–µ—â–µ—Å—Ç–≤–∞ / total volume
    totalConcentration = (totalPureML / tv) * 100;
  } else if (totalML > 0) {
    // –ï—Å–ª–∏ total volume –Ω–µ –∑–∞–¥–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—É–º–º—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    // (–Ω–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–¥–∞—Å—Ç total volume)
    totalConcentration = (totalPureML / totalML) * 100;
  }

  document.getElementById('stat-ml').textContent =
    totalML.toFixed(3);

  document.getElementById('stat-percent').textContent =
    totalConcentration.toFixed(2);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É total_ml –∏ total_volume
  const warningDiv = document.getElementById('volume-warning');
  if (tv && totalML > 0) {
    const diff = Math.abs(totalML - tv);
    const tolerance = 0.01; // –î–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ 0.01 –º–ª
    if (diff > tolerance) {
      warningDiv.style.display = 'block';
    } else {
      warningDiv.style.display = 'none';
    }
  } else {
    warningDiv.style.display = 'none';
  }
}



function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–±–µ–∑ —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ PDF)
  const formulaTitle = title.value || 'Untitled Formula';
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('Mini Parf LIMS', 14, 20);
  doc.setFontSize(14);
  doc.setFont(undefined, 'normal');
  doc.text(formulaTitle, 14, 30);
  
  let yPos = 40;
  
  // –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('General Information', 14, yPos);
  yPos += 8;
  
  doc.setFont(undefined, 'normal');
  doc.setFontSize(10);
  const totalML = document.getElementById('stat-ml').textContent;
  const totalConc = document.getElementById('stat-percent').textContent;
  const totalVol = totalVolume.value || 'not set';
  
  doc.text(`Total volume: ${totalVol} ml`, 20, yPos);
  yPos += 6;
  doc.text(`Total ml (components): ${totalML} ml`, 20, yPos);
  yPos += 6;
  doc.text(`Total concentration: ${totalConc}%`, 20, yPos);
  yPos += 12;
  
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä—è–¥—ã —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π
  let globalRowNumber = 1;
  
  // –¢–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ—Ç—ã
  NOTES.forEach((note, noteIndex) => {
    const noteRows = rows.filter(r => r.note === note.key);
    
    if (noteRows.length === 0) return;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ—Ç—ã
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text(note.label.toUpperCase(), 14, yPos);
    yPos += 8;
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π
    const tableData = noteRows.map(r => {
      const rowNum = globalRowNumber++;
      return [
        rowNum.toString(),
        r.name || '-',
        r.concentration ? parseFloat(r.concentration).toFixed(2) + '%' : '-',
        r.amount_percent ? parseFloat(r.amount_percent).toFixed(2) + '%' : '-',
        r.amount_ml ? parseFloat(r.amount_ml).toFixed(3) + ' ml' : '-'
      ];
    });
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    doc.autoTable({
      startY: yPos,
      head: [['#', 'Name', 'Conc %', 'Amount %', 'Amount ml']],
      body: tableData,
      theme: 'striped',
      headStyles: { fillColor: [60, 60, 60], textColor: 255, fontStyle: 'bold' },
      styles: { fontSize: 9, cellPadding: 3 },
      columnStyles: {
        0: { cellWidth: 15 },
        1: { cellWidth: 80 },
        2: { cellWidth: 30 },
        3: { cellWidth: 30 },
        4: { cellWidth: 35 }
      },
      margin: { left: 14, right: 14 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    if (yPos > 270 && noteIndex < NOTES.length - 1) {
      doc.addPage();
      yPos = 20;
    }
  });
  
  // –§—É—Ç–µ—Ä —Å –¥–∞—Ç–æ–π
  const pageCount = doc.internal.getNumberOfPages();
  const dateStr = new Date().toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128);
    doc.text(
      `Page ${i} of ${pageCount} | Created: ${dateStr}`,
      14,
      doc.internal.pageSize.height - 10
    );
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  const fileName = `${formulaTitle.replace(/[^a-z0-9]/gi, '_') || 'formula'}.pdf`;
  doc.save(fileName);
}

function saveJSON() {
  const data = {
    title: title.value,
    total_volume: totalVolume.value,
    rows
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${title.value || 'formula'}.json`;
  a.click();
}

function loadJSON(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    const data = JSON.parse(reader.result);
    title.value = data.title || '';
    totalVolume.value = data.total_volume || '';
    rows = data.rows || [];
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –µ—Å—Ç—å –ø–æ–ª–µ ifra_max (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    rows.forEach(r => {
      if (r.ifra_max === undefined) {
        r.ifra_max = '';
      }
    });
    render();
  };
  reader.readAsText(file);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è sticky header
function positionStickyHeader() {
  const headerSection = document.querySelector('.header-section');
  const stickyHeader = document.querySelector('.sticky-table-header');
  if (headerSection && stickyHeader) {
    const headerHeight = headerSection.offsetHeight;
    stickyHeader.style.top = headerHeight + 'px';
  }
}

// –í—ã–∑—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('load', positionStickyHeader);
window.addEventListener('resize', positionStickyHeader);

/* init */
NOTES.forEach(n => addRow(n.key));
</script>

</body>
</html>
